% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/core_manifold_construction.R
\name{calculate_manifold_affinity_core}
\alias{calculate_manifold_affinity_core}
\title{Calculate Manifold Affinity and Markov Matrix (Core)}
\usage{
calculate_manifold_affinity_core(
  L_library_matrix,
  k_local_nn_for_sigma,
  use_sparse_W_params = list(),
  distance_engine = c("euclidean", "ann_euclidean"),
  ann_threshold = 10000
)
}
\arguments{
\item{L_library_matrix}{A p x N matrix of HRF shapes, where p is the number
of time points and N is the number of HRFs in the library}

\item{k_local_nn_for_sigma}{Positive integer (\< N), k-nearest neighbors for self-tuning
bandwidth calculation (e.g., 7)}

\item{use_sparse_W_params}{List with optional parameters for sparse W matrix:
\itemize{
\item \code{sparse_if_N_gt}: Threshold for N to switch to sparse matrix (e.g., 5000)
\item \code{k_nn_for_W_sparse}: Number of nearest neighbors to keep in sparse W
}}
\item{distance_engine}{Character string specifying the distance computation method. Options are \code{"euclidean"} for exact distances or \code{"ann_euclidean"} for approximate nearest neighbors via RcppHNSW. If \code{"ann_euclidean"} is requested but RcppHNSW is not installed, the function falls back to exact distances with a warning.}
\item{ann_threshold}{Integer. When \code{distance_engine = "euclidean"} and the number of HRFs exceeds this threshold, the function will attempt to use RcppHNSW for approximate neighbors if available.}
}
\value{
S_markov_matrix An N x N Markov transition matrix (regular or sparse
Matrix format depending on parameters). Each row sums to 1.
}
\description{
Computes a Markov transition matrix for HRF manifold construction using
self-tuning bandwidth for local scaling of affinities.
}
\details{
This function implements the affinity matrix construction from
Component 0, Step 1 of the M-HRF-LSS pipeline. It uses the self-tuning
local scaling method from Zelnik-Manor & Perona (2005) where each HRF's
bandwidth sigma_i is set to its k-th nearest neighbor distance.
The \code{distance_engine} argument controls whether exact or approximate
nearest neighbor distances are used. When \code{"ann_euclidean"} is chosen but
the \CRANpkg{RcppHNSW} package is unavailable, the function falls back to exact
distances with a warning.
}
\examples{
\dontrun{
# Create synthetic HRF library
p <- 30  # time points
N <- 100 # number of HRFs
L_library <- matrix(rnorm(p * N), nrow = p, ncol = N)

# Compute Markov matrix
S <- calculate_manifold_affinity_core(L_library, k_local_nn_for_sigma = 7)

# With sparse matrix for large N
S_sparse <- calculate_manifold_affinity_core(
  L_library, 
  k_local_nn_for_sigma = 7,
  use_sparse_W_params = list(sparse_if_N_gt = 50, k_nn_for_W_sparse = 20)
)
}

}
