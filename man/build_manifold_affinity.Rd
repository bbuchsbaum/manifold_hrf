% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/core_manifold_construction_refactored.R
\name{build_manifold_affinity}
\alias{build_manifold_affinity}
\title{Build Sparse Affinity Matrix from HRF Library}
\usage{
build_manifold_affinity(
  L_library_matrix,
  k,
  k_sigma = NULL,
  normalization = c("symmetric", "row_stochastic"),
  handle_isolated = c("warn_remove", "error", "connect_to_self"),
  ann_method = c("auto", "RANN", "RcppHNSW", "exact"),
  return_diagnostics = TRUE
)
}
\arguments{
\item{L_library_matrix}{A p x N matrix of HRF shapes, where p is the number
of time points and N is the number of HRFs in the library}

\item{k}{Number of nearest neighbors for graph construction}

\item{k_sigma}{Number of nearest neighbors for sigma estimation (default = k)}

\item{normalization}{Normalization method: "symmetric" (for diffusion maps)
or "row_stochastic" (for Markov chains). Default is "symmetric".}

\item{handle_isolated}{How to handle isolated nodes: "error", "warn_remove",
or "connect_to_self". Default is "warn_remove".}

\item{ann_method}{Backend for k-NN search: "auto", "RANN", "RcppHNSW", or "exact"}

\item{return_diagnostics}{Whether to return additional diagnostic information}
}
\value{
A list object of class 'manifold_affinity' containing:
\itemize{
\item \code{W}: Raw sparse affinity matrix
\item \code{T_norm}: Normalized sparse matrix (symmetric or row-stochastic)
\item \code{normalization}: Normalization method used
\item \code{params}: List of parameters used
\item \code{diagnostics}: Optional diagnostics (sigma values, isolated nodes, etc.)
}
}
\description{
Computes a sparse affinity matrix using self-tuning local scaling,
with proper handling of normalization and isolated nodes.
}
\details{
This function implements a corrected version of the affinity matrix
construction from Component 0 of the M-HRF-LSS pipeline. Key improvements:
\itemize{
\item Always uses sparse matrices to avoid memory issues
\item Properly handles normalization (symmetric vs row-stochastic)
\item No global diagonal regularization (only isolated node handling)
\item Returns rich diagnostic information
}
}
